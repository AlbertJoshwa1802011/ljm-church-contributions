<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Loading LJM Church Contributions</title>
<style>
body { display:flex; align-items:center; justify-content:center; height:100vh; font-family:Arial,sans-serif; background:#f9f9f9; margin:0; }
.loader-container { text-align:center; }
.loader { border: 6px solid #f3f3f3; border-top: 6px solid #2c7be5; border-radius:50%; width:60px; height:60px; animation: spin 1s linear infinite; margin:auto 0 20px; }
@keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
h2 { color:#2c3e50; }
</style>
</head>
<body>
<div class="loader-container">
    <div class="loader"></div>
    <h2>Preparing Fund Data, please wait...</h2>
</div>

<script>
const FUND_URLS = {
    tech: "https://script.google.com/macros/s/AKfycbyn7BAXvOI-GRNI3DfFBXc6tBAgcuwlKu2PWgJ-JKi-ShZEP-eOnzmvxC01AjGsevQd/exec?fund=tech-contributions",
    christmas: "https://script.google.com/macros/s/AKfycbyn7BAXvOI-GRNI3DfFBXc6tBAgcuwlKu2PWgJ-JKi-ShZEP-eOnzmvxC01AjGsevQd/exec?fund=christmas-fund"
};
const CACHE_VERSION = 1;
const CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes

function getCachedFund(key) {
    try {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (parsed.version !== CACHE_VERSION) { localStorage.removeItem(key); return null; }
        const age = Date.now() - (parsed.lastFetched || 0);
        if (age < 0 || age > CACHE_TTL_MS) { localStorage.removeItem(key); return null; }
        return parsed.data || null;
    } catch (e) {
        try { localStorage.removeItem(key); } catch (_) {}
        return null;
    }
}

function setCachedFund(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify({ data, lastFetched: Date.now(), version: CACHE_VERSION }));
    } catch (err) { /* storage full - continue without cache */ }
}

// Fetch a fund and store in localStorage if not cached
async function fetchFundIfNeeded(key, url) {
    const cached = getCachedFund(key + "FundData");
    if (cached) return cached;

    try {
        const res = await fetch(url + '&_t=' + Date.now(), { credentials:'omit', cache:'no-store' });
        const data = await res.json();
        setCachedFund(key + "FundData", { contributions: data.contributions || [], goalAmount: data.goalAmount || 0 });
        return data;
    } catch(err) {
        console.error(`Error fetching ${key} fund:`, err);
        return { contributions: [], goalAmount: 0 };
    }
}

// Fetch both funds in parallel
async function initAllFunds() {
    await Promise.all([
        fetchFundIfNeeded("tech", FUND_URLS.tech),
        fetchFundIfNeeded("christmas", FUND_URLS.christmas)
    ]);
    // Redirect to main page (Tech Fund by default)
    window.location.href = "index.html?fund=Tech Fund";
}

initAllFunds();
</script>
</body>
</html>
